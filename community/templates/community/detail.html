{% extends 'base.html' %}

{% block content %}

<style>

  @import url('https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Gothic+A1&family=Poor+Story&display=swap');

  #title {
    font-family: 'Do Hyeon', sans-serif;
    font-size: 50px;
  }

  #content {
    font-family: 'Gothic A1', sans-serif;
    font-size: 20px;
  }

  #info {
    font-family: 'Gothic A1', sans-serif;
    font-size: 20px;
  
  }

</style>
  <h3 id="title" class="mt-5 fw-bold text-center" style="text-decoration:none; color:white; border-radius: 5em; padding: 0.5em; background: #FFBEBE">{{ review.title }}</h3>
  <br>
  <div style="border: 3px dashed #C6C6C6; padding: 0.6em;">
    <br>
    {% if review.movie_title %}
      <p id="info" class="fw-bold">ğŸ“½ ì˜í™” ì œëª©: {{ review.movie_title }}</p>
      {% if review.rank %}
        <p id="info">â­ í‰ì : {{ review.rank }}</p>
      {% endif %}
    {% endif %}
    <hr style="border: dashed;" class="mb-4">
    <p id="content" >ğŸ”— ë‚´ìš©: {{ review.content }}</p>
    <hr style="border: dashed;" class="mb-4">
    <div id="info" style="display: inline;">ğŸ˜ ì‘ì„±ì: <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user}}</a></div>
    <br>
    <br>
    <p id="info" style="font-size:15px;">â± ì‘ì„± ì‹œê°: {{ review.created_at }}</p>
    <p id="info" style="font-size:15px;">â± ìˆ˜ì • ì‹œê°: {{ review.updated_at }}</p>

    <form id="likeForm" action="{% url 'community:like' review.pk %}" method="POST" class="d-inline">
      {% csrf_token %}
      {% if user in review.like_users.all %}
        <button style="color:red;" class="btn fa fa-heart">ã€€ì¶”ì²œ ì·¨ì†Œ</button>
      {% else %}
        <button style="color:black;" class="btn fa fa-heart">ã€€ì¶”ì²œ</button>
      {% endif %}
      <br>
      <br>
      <p>{{ review.like_users.all|length }} ëª…ì´ ì´ ê¸€ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>

    </form>
  </div>
  <div align="right">
    {% if request.user == review.user %}
      <form action="{% url 'community:delete' review.pk %}" method="POST" style="display: inline">
        {% csrf_token %}
        <input type="submit" class="btn btn-outline-danger mt-3" value="ì‚­ì œ">
      </form>
      <form action="{% url 'community:update' review.pk %}" method="POST" style="display: inline">
        {% csrf_token %}
        <input type="submit" class="btn btn-outline-danger mt-3" value="ìˆ˜ì •">
      </form>
    {% endif %}
  </div>
  <br>
  <hr>
  <hr>
  <div id="comment">
    {% if comments|length %}
      <p style="font-size: 20px;"><b>{{ comments|length }}ê°œì˜ ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤.</b></p>
    {% endif %}
    {% for comment in comments %}
      <div id="info" style="font-size:15px;">
        ğŸ¥¨ã€€{{ comment.user }} :: {{ comment.content }}
        {% if comment.user == request.user %}
        <button id="delete" class="{{comment.pk}} mx-3 btn btn-sm btn-outline-danger">ì‚­ì œ</button>
        <p>------------------------------------------------------</p>
        {% endif %}
      </div>
    {% empty %}
      <p><b>ëŒ“ê¸€ì´ ì—†ì–´ìš”..</b></p>
    {% endfor %}
  </div>
  <hr>
  <hr>
  <br>

  {% if request.user.is_authenticated %}
    <form action="{% url 'community:create_comment' review.pk %}" method="POST" style="display:inline-block; height:100px;">
      {% csrf_token %}
      <div style="width:400px; display:inline-block;" >
        <p>ëŒ“ê¸€ : </p>
        {{ comment_form.content }}
      </div>
      <input type="submit" class="btn btn-sm btn-outline-success mx-3" value="ë“±ë¡" style="display:inline-block; margin-bottom:20px ;">
    </form>
  {% else %}
    <a href="{% url 'accounts:login' %}">[ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.]</a>
  {% endif %}
  <br>
  <a href="{% url 'community:index' %}">[back]</a>
{% endblock  %}

{% block script %}
<script>
  const likeforms = document.querySelectorAll('#likeForm')
  likeforms.forEach(likeform => {
    likeform.addEventListener('click', function(event){
      event.preventDefault()
      const likebtn = likeform.children[1]
      const likep = likeform.children[4]

      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'

      axios.post(likeform.action)
      .then(response => {
        console.log('ë”¸ê¹')
        if (likebtn.innerText == 'ã€€ì¶”ì²œ'){
          likebtn.innerText = 'ã€€ì¶”ì²œ ì·¨ì†Œ'
          likebtn.style = 'color:red;'
        } else {
          likebtn.innerText = 'ã€€ì¶”ì²œ'
          likebtn.style= 'color:black'
        }
        likep.innerText = `${response.data.count} ëª…ì´ ì´ ê¸€ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.`
      }) 
    })
  })

  const review_pk = {{ review.pk }}
  const delete_buttons = document.querySelectorAll('#delete')
  delete_buttons.forEach(delete_button => {
    delete_button.addEventListener('click', function(){
      const comment_pk = delete_button.className.split(' ')[0]

      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'

      axios.post(`http://127.0.0.1:8000/community/${review_pk}/comments/${comment_pk}/delete`)
      .then(res =>
      $('#comment').load(window.location.href+' #comment'))
      .catch(err =>
      console.log(err))
    })
  })
</script>
{% endblock script %}